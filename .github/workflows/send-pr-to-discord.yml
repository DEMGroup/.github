name: Send PR message to discord

on:
  pull_request:
    types:
      - unlabeled
      - opened
      - edited
      - reopened
      - synchronize
      - ready_for_review
  workflow_call:

jobs:
  short-circuit:
    uses: DEMGroup/.github/.github/workflows/short-circuit.yml@main
    with:
      short-circuit-label: "discord-pr-sent"

  notify-discord-pr:
    needs: [short-circuit]
    # run on call or open/unlabel/reopen and not wip/Automated Update
    if: |
      needs.short-circuit.outputs.short-circuit != 'true' &&
      (
        github.event_name == 'workflow_call' ||
        (
          github.base_ref == github.event.repository.default_branch &&
          !contains(github.event.pull_request.labels.*.name, 'wip') &&
          !startsWith(github.event.pull_request.title, 'Automated Update')
        )
      )
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Dump job context
        env:
          JOB_CONTEXT: ${{ toJson(job) }}
        run: echo "$JOB_CONTEXT"
      - name: Dump steps context
        env:
          STEPS_CONTEXT: ${{ toJson(steps) }}
        run: echo "$STEPS_CONTEXT"
      - name: Dump runner context
        env:
          RUNNER_CONTEXT: ${{ toJson(runner) }}
        run: echo "$RUNNER_CONTEXT"
      - name: Dump strategy context
        env:
          STRATEGY_CONTEXT: ${{ toJson(strategy) }}
        run: echo "$STRATEGY_CONTEXT"
      - name: Dump matrix context
        env:
          MATRIX_CONTEXT: ${{ toJson(matrix) }}
        run: echo "$MATRIX_CONTEXT"
      # NATHANS SHIT HERE

      - name: Check for hook url
        env:
          PR_WEBHOOK_URL: ${{ secrets.PR_WEBHOOK_URL }}
        if: ${{ env.PR_WEBHOOK_URL == '' }}
        run: |
          echo '## 🏴💀 You are missing `secrets.PR_WEBHOOK_URL` from your repository. Please add it [here](https://github.com/${{github.repository_owner}}/settings/secrets/actions). 💀🏴' >> $GITHUB_STEP_SUMMARY
          exit 1

      - uses: actions/checkout@v3
      - name: Set vars
        id: vars
        run: |
          descTitle=$(echo "${{github.repository}} PR #${{ github.event.pull_request.number }}" | sed s/"DEMGroup\/"//)
         
          if (${{ github.event.pull_request.body == '' }}); then
            descTitle=""
            descBody=""
          else
            
            descBody="${{ github.event.pull_request.body }}"
            descBody="${descBody//'%'/'%25'}"
            descBody="${descBody//$'\n'/'%0A'}"
            descBody="${descBody//$'\r'/'%0D'}"

          fi
          
          echo "botName=$(echo "${{github.repository}} PR Hook Bot" | sed 's/DEMGroup\///g')" >> $GITHUB_OUTPUT
          echo "prTitle=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "descriptionLabel=$descTitle" >> $GITHUB_OUTPUT
          echo "descriptionBody=$descBody" >> $GITHUB_OUTPUT
      
  
      - name: Custom Discord PR message
        run: |
          descBody=$(echo "${{ steps.vars.outputs.descriptionBody }}" |sed  's/%0D%0A/\\n/g')

          generate_post_data() {
              cat <<EOF
              {
                "content": null,
                "embeds": [
                  {
                    "title": "${{ steps.vars.outputs.prTitle }}",
                    "description": "**Title**: ${{ github.event.pull_request.title }}\n **Link**: [${{steps.vars.outputs.prTitle}}](${{github.event.pull_request.html_url}})\n**Author**: <@${{ github.event.pull_request.user.login }}>\n${{ steps.vars.outputs.descriptionLabel }}\n$descBody",
                    "color": null
                  }
                ],
                "username": "${{ steps.vars.outputs.botName }}",
                "avatar_url": "https://app.aesircrypto.com/assets/logo.png",
                "attachments": []
              }
            EOF
          }
          curl -H "Content-Type: application/json" -X POST -d "$(generate_post_data)" ${{ secrets.PR_WEBHOOK_URL }}
 
      # - name: Discord Webhook Action
      #   uses: tsickert/discord-webhook@v5.3.0
      #   with:
      #     webhook-url: ${{ secrets.PR_WEBHOOK_URL }}
      #     username: "${{ steps.vars.outputs.botName }}"
      #     avatar-url: "https://app.aesircrypto.com/assets/logo.png"
      #     embed-title: "${{ steps.vars.outputs.prTitle }}"
      #     embed-description:
      #       "**Title**: ${{ github.event.pull_request.title }}\n
      #       **Link**: [${{steps.vars.outputs.prTitle}}](${{github.event.pull_request.html_url}})\n
      #       **Author**: <@${{ github.event.pull_request.user.login }}>\n
      #       ${{ steps.vars.outputs.descriptionLabel }} \n ${{ steps.vars.outputs.descriptionBody }}" 
      - name: Add the pr comment
        uses: thollander/actions-comment-pull-request@v2.3.1
        with:
          message: |
            ### :envelope_with_arrow: ${{ steps.vars.outputs.botName }} Sent a messsage to discord for this PR :outbox_tray:
            **Title**: ${{ github.event.pull_request.title }}
            **Link**: [${{steps.vars.outputs.prTitle}}](${{github.event.pull_request.html_url}})
            **Author**: @${{ github.event.pull_request.user.login }}
            ${{ steps.vars.outputs.descriptionLabel }}
            ${{ steps.vars.outputs.descriptionBody }}
            If you add a `wip` label before submitting it will skip this next time.

      - name: Add dotnet label to PR
        id: label-it-pr-sent
        uses: actions-ecosystem/action-add-labels@v1.1.0
        with:
          github_token: ${{ github.token }}
          labels: discord-pr-sent
